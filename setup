#!/bin/bash

#############
# Functions #
#############

# Argument $1: The name of the Homebrew package
# Argument $2: Optional custom code to run instead of Homebrew install
check_dependency () {
        command -v $1 >/dev/null 2>&1
        if [ ! $? -eq 0 ]; then
                if [ -z "$2" ]; then
                        echo "Installing $1"
                        brew update
                        brew install $1
                else
                        echo "Executing custom commands:\n"
                        eval $2
                fi
        fi
}

############
# Homebrew #
############

# Check that Homebrew is installed
# Do this manually because we need it for the check_dependency function
command -v brew >/dev/null 2>&1
if [ ! $? -eq 0 ]; then
        # If we don't have Homebrew
        # set it up at ~/homebrew

        if [[ -d ~/homebrew ]]; then
                rm -rf ~/homebrew
        fi

        cd ~

        mkdir ~/homebrew && curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
fi

check_dependency "ag" "brew update && brew install the_silver_searcher"
check_dependency "cmake"
check_dependency "git"
check_dependency "nvim"
check_dependency "python"
check_dependency "node"
check_dependency "npm"

########################
# Neovim Configuration #
########################

nvim_directory=~/.config/nvim

# Make sure that the directory exists
if [ ! -d $nvim_directory ]; then
        mkdir -p $nvim_directory
fi

# Check for files / symlinks that are already there
if [ -f $nvim_directory/init.vim ] || [ -h $nvim_directory/init.vim ]; then
        rm -f $nvim_directory/init.vim
fi

# Symlink the config file
ln -s $PWD/Neovim/init.vim $nvim_directory/init.vim

# Install Pathogen
## First check if the directories for it exist
if [ ! -d $nvim_directory/autoload ]; then
        mkdir -p $nvim_directory/autoload
fi

if [ ! -d $nvim_directory/bundle ]; then
        mkdir -p $nvim_directory/bundle
fi

if [ ! -f $nvim_directory/autoload/pathogen.vim ]; then
        curl -LSso $nvim_directory/autoload/pathogen.vim https://tpo.pe/pathogen.vim
fi

# Install Pathogen Plugins
./Neovim/plugins

#########################
# Node.js Configuration #
#########################

# TODO: Do this the right way.

# Install prettier-standard (since we use this for work)
check_dependency "prettier-standard" "npm i prettier-standard -g"
check_dependency "language-server" "npm i javascript-typescript-langserver -g"

# HACK: This should be part of the Neovim setup file
# Install the Neovim NPM package
if [[ ! "$(npm ls -g --depth=0)" =~ "neovim" ]]; then
        printf "Installing neovim NPM package:\n"
        npm i neovim -g
fi
